<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>معاينة التقرير - نظام تقييم الآلات والمعدات</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;500;600;700;800&family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- SweetAlert2 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/forms.css">
    <link rel="stylesheet" href="css/responsive.css">
    
    <style>
        /* ستايلات إضافية للطباعة */
        @media print {
            body {
                background: white !important;
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            
            .no-print {
                display: none !important;
            }
            
            .preview-paper {
                box-shadow: none !important;
                margin: 0 !important;
            }
            
            .page-break {
                page-break-before: always;
            }
        }
        
        .preview-paper {
            background: white;
            max-width: 210mm;
            margin: 0 auto;
            padding: 0;
        }
        
        .report-watermark {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 100px;
            color: rgba(0, 0, 0, 0.03);
            font-weight: bold;
            pointer-events: none;
            z-index: 0;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar no-print">
        <div class="nav-container">
            <a href="index.html" class="nav-brand">
                <i class="fas fa-cogs"></i>
                <span>نظام التقييم</span>
            </a>
            
            <button class="nav-toggle" id="navToggle">
                <i class="fas fa-bars"></i>
            </button>
            
            <ul class="nav-menu" id="navMenu">
                <li><a href="index.html" class="nav-link"><i class="fas fa-home"></i> الرئيسية</a></li>
                <li><a href="new-report.html" class="nav-link"><i class="fas fa-plus-circle"></i> تقرير جديد</a></li>
                <li><a href="reports.html" class="nav-link"><i class="fas fa-folder-open"></i> التقارير</a></li>
                <li><a href="settings.html" class="nav-link"><i class="fas fa-cog"></i> الإعدادات</a></li>
            </ul>
            
            <button class="theme-toggle" id="themeToggle" title="تبديل الوضع الليلي">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </nav>
    
    <!-- Nav Overlay -->
    <div class="nav-overlay" id="navOverlay"></div>

    <!-- Page Content -->
    <div class="page-content">
        <div class="page-header no-print">
            <div class="container">
                <div class="page-title">
                    <h1><i class="fas fa-eye"></i> معاينة التقرير</h1>
                    <p>راجع التقرير قبل التصدير أو الطباعة</p>
                </div>
                <nav class="breadcrumb">
                    <a href="index.html">الرئيسية</a>
                    <i class="fas fa-chevron-left"></i>
                    <a href="reports.html">التقارير</a>
                    <i class="fas fa-chevron-left"></i>
                    <span>معاينة</span>
                </nav>
            </div>
        </div>

        <div class="container preview-container">
            <!-- أزرار التحكم -->
            <div class="preview-actions no-print">
                <a href="reports.html" class="btn btn-outline">
                    <i class="fas fa-arrow-right"></i>
                    رجوع للتقارير
                </a>
                <div class="btn-group">
                    <button class="btn btn-outline" id="editBtn">
                        <i class="fas fa-edit"></i>
                        تعديل
                    </button>
                    <button class="btn btn-outline" id="printBtn">
                        <i class="fas fa-print"></i>
                        طباعة
                    </button>
                    <button class="btn btn-outline" id="emailBtn">
                        <i class="fas fa-envelope"></i>
                        إرسال
                    </button>
                    <button class="btn btn-success" id="exportPdfBtn">
                        <i class="fas fa-file-pdf"></i>
                        تصدير PDF
                    </button>
                </div>
            </div>

            <!-- ورقة التقرير -->
            <div class="preview-paper" id="reportContent">
                <!-- ترويسة التقرير -->
                <div class="report-header">
                    <div class="report-header-top">
                        <div class="company-info">
                            <div class="company-logo" id="companyLogo">
                                <i class="fas fa-building"></i>
                            </div>
                            <div class="company-details">
                                <h2 id="companyName">اسم الشركة</h2>
                                <p id="companyAddress">العنوان</p>
                                <p id="companyContact">الهاتف | البريد الإلكتروني</p>
                                <p id="companyLicense">رقم الترخيص:</p>
                            </div>
                        </div>
                        <div class="report-meta">
                            <p><strong>رقم التقرير:</strong> <span id="reportNumber">-</span></p>
                            <p><strong>تاريخ التقرير:</strong> <span id="reportDate">-</span></p>
                            <p><strong>المقيّم:</strong> <span id="evaluatorName">-</span></p>
                        </div>
                    </div>
                    <div class="report-title">
                        <h1 id="reportTitle">تقرير تقييم الآلات والمعدات</h1>
                    </div>
                </div>

                <!-- محتوى التقرير -->
                <div class="report-content">
                    <!-- المقدمة -->
                    <div class="report-section">
                        <h3><i class="fas fa-info-circle"></i> مقدمة</h3>
                        <p id="reportIntro">
                            بناءً على طلب العميل، قام فريقنا المتخصص بإجراء تقييم شامل للآلات والمعدات المذكورة في هذا التقرير،
                            وذلك وفقاً للمعايير المهنية المعتمدة في مجال تقييم الأصول المنقولة.
                        </p>
                    </div>

                    <!-- معلومات العميل -->
                    <div class="report-section">
                        <h3><i class="fas fa-user"></i> معلومات العميل</h3>
                        <table class="info-table">
                            <tr>
                                <td>اسم العميل</td>
                                <td id="clientName">-</td>
                            </tr>
                            <tr>
                                <td>رقم الهوية / السجل</td>
                                <td id="clientId">-</td>
                            </tr>
                            <tr>
                                <td>رقم الجوال</td>
                                <td id="clientPhone">-</td>
                            </tr>
                            <tr>
                                <td>البريد الإلكتروني</td>
                                <td id="clientEmail">-</td>
                            </tr>
                            <tr>
                                <td>العنوان</td>
                                <td id="clientAddress">-</td>
                            </tr>
                        </table>
                    </div>

                    <!-- نطاق العمل -->
                    <div class="report-section">
                        <h3><i class="fas fa-bullseye"></i> نطاق العمل والغرض من التقييم</h3>
                        <table class="info-table">
                            <tr>
                                <td>الغرض من التقييم</td>
                                <td id="evaluationPurpose">-</td>
                            </tr>
                            <tr>
                                <td>الجهة الطالبة</td>
                                <td id="requestingEntity">-</td>
                            </tr>
                            <tr>
                                <td>طريقة التقييم</td>
                                <td id="valuationMethod">-</td>
                            </tr>
                        </table>
                    </div>

                    <!-- تفاصيل الآلات -->
                    <div class="report-section" id="machinesSection">
                        <h3><i class="fas fa-cogs"></i> تفاصيل الآلات المقيّمة</h3>
                        <div id="machinesList">
                            <!-- سيتم ملؤها بواسطة JavaScript -->
                        </div>
                    </div>

                    <!-- ملخص القيم -->
                    <div class="report-section">
                        <h3><i class="fas fa-coins"></i> ملخص القيم المقدرة</h3>
                        <table class="values-table">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>وصف الآلة</th>
                                    <th>الحالة</th>
                                    <th>القيمة المقدرة</th>
                                </tr>
                            </thead>
                            <tbody id="valuesTableBody">
                                <!-- سيتم ملؤها بواسطة JavaScript -->
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3"><strong>الإجمالي</strong></td>
                                    <td class="total-value" id="totalValue">0 ر.س</td>
                                </tr>
                                <tr>
                                    <td colspan="4" id="totalValueWords">صفر ريال سعودي فقط لا غير</td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>

                    <!-- أساس التقييم -->
                    <div class="report-section">
                        <h3><i class="fas fa-balance-scale"></i> أساس وطريقة التقييم</h3>
                        <p id="valuationBasis">-</p>
                    </div>

                    <!-- التوصيات -->
                    <div class="report-section" id="recommendationsSection">
                        <h3><i class="fas fa-lightbulb"></i> التوصيات والملاحظات</h3>
                        <p id="recommendations">-</p>
                    </div>

                    <!-- الملاحظات العامة -->
                    <div class="report-section" id="notesSection" style="display: none;">
                        <h3><i class="fas fa-sticky-note"></i> ملاحظات عامة</h3>
                        <p id="generalNotes">-</p>
                    </div>
                </div>

                <!-- ذيل التقرير -->
                <div class="report-footer">
                    <div class="signature-box">
                        <div class="signature-line" id="signatureLine"></div>
                        <p><strong>توقيع المقيّم</strong></p>
                        <p id="evaluatorSignName">-</p>
                    </div>
                    <div class="signature-box">
                        <div class="signature-line"></div>
                        <p><strong>ختم الشركة</strong></p>
                        <p id="stampDate">-</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer no-print">
        <div class="container">
            <div class="footer-bottom">
                <p>&copy; 2026 نظام تقييم الآلات والمعدات - جميع الحقوق محفوظة</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script src="js/utils.js"></script>
    <script src="js/storage.js"></script>
    <script src="js/pdf-generator.js"></script>
    <script src="js/app.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            initPreviewPage();
        });
        
        function initPreviewPage() {
            // الحصول على معرف التقرير من URL
            const params = new URLSearchParams(window.location.search);
            const reportId = params.get('id');
            const autoExport = params.get('export') === 'true';
            
            if (!reportId) {
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'لم يتم تحديد التقرير',
                    confirmButtonText: 'العودة للتقارير'
                }).then(() => {
                    window.location.href = 'reports.html';
                });
                return;
            }
            
            // تحميل بيانات التقرير
            const report = Storage.getReport(reportId);
            
            if (!report) {
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'لم يتم العثور على التقرير',
                    confirmButtonText: 'العودة للتقارير'
                }).then(() => {
                    window.location.href = 'reports.html';
                });
                return;
            }
            
            // عرض بيانات التقرير
            displayReport(report);
            
            // تهيئة الأحداث
            initPreviewEvents(reportId);
            
            // التصدير التلقائي إذا طلب
            if (autoExport) {
                setTimeout(() => exportToPDF(), 1000);
            }
        }
        
        function displayReport(report) {
            // تحميل إعدادات الشركة
            const settings = Storage.getSettings() || {};
            
            // معلومات الشركة
            if (settings.companyLogo) {
                document.getElementById('companyLogo').innerHTML = `<img src="${settings.companyLogo}" alt="شعار الشركة">`;
            }
            document.getElementById('companyName').textContent = settings.companyName || 'اسم الشركة';
            document.getElementById('companyAddress').textContent = settings.companyAddress || 'العنوان';
            document.getElementById('companyContact').textContent = 
                `${settings.companyPhone || ''} | ${settings.companyEmail || ''}`;
            document.getElementById('companyLicense').textContent = 
                `رقم الترخيص: ${settings.companyLicense || '-'}`;
            
            // معلومات التقرير
            document.getElementById('reportNumber').textContent = report.projectNumber || '-';
            document.getElementById('reportDate').textContent = Utils.formatDate(report.evaluationDate);
            document.getElementById('evaluatorName').textContent = report.evaluatorName || '-';
            
            // عنوان التقرير
            const reportTitle = Utils.getEvaluationTypeName(report.evaluationType);
            document.getElementById('reportTitle').textContent = `تقرير ${reportTitle}`;
            
            // معلومات العميل
            document.getElementById('clientName').textContent = report.clientName || '-';
            document.getElementById('clientId').textContent = report.clientId || '-';
            document.getElementById('clientPhone').textContent = report.clientPhone || '-';
            document.getElementById('clientEmail').textContent = report.clientEmail || '-';
            document.getElementById('clientAddress').textContent = 
                `${report.clientCity || ''} - ${report.clientAddress || ''}`;
            
            // نطاق العمل
            document.getElementById('evaluationPurpose').textContent = reportTitle;
            document.getElementById('requestingEntity').textContent = report.requestingEntity || '-';
            document.getElementById('valuationMethod').textContent = 
                Utils.getValuationMethodName(report.valuationMethod);
            
            // الآلات
            displayMachines(report.machines || []);
            
            // ملخص القيم
            displayValuesTable(report.machines || []);
            
            // أساس التقييم
            document.getElementById('valuationBasis').textContent = report.valuationBasis || '-';
            
            // التوصيات
            if (report.recommendations) {
                document.getElementById('recommendations').textContent = report.recommendations;
            } else {
                document.getElementById('recommendationsSection').style.display = 'none';
            }
            
            // الملاحظات
            if (report.generalNotes) {
                document.getElementById('generalNotes').textContent = report.generalNotes;
                document.getElementById('notesSection').style.display = 'block';
            }
            
            // التوقيع
            document.getElementById('evaluatorSignName').textContent = report.evaluatorName || '-';
            document.getElementById('stampDate').textContent = Utils.formatDate(report.evaluationDate);
        }
        
        function displayMachines(machines) {
            const container = document.getElementById('machinesList');
            
            if (machines.length === 0) {
                container.innerHTML = '<p class="text-muted">لم يتم إضافة آلات</p>';
                return;
            }
            
            container.innerHTML = machines.map((machine, index) => `
                <div class="machine-detail-card" style="margin-bottom: 20px; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px;">
                    <h4 style="color: var(--primary-color); margin-bottom: 10px;">
                        ${index + 1}. ${machine.name || machine.type || 'آلة غير محددة'}
                    </h4>
                    <table class="info-table">
                        <tr>
                            <td>النوع</td>
                            <td>${machine.type || '-'}</td>
                            <td>الموديل</td>
                            <td>${machine.model || '-'}</td>
                        </tr>
                        <tr>
                            <td>الرقم التسلسلي</td>
                            <td>${machine.serial || '-'}</td>
                            <td>سنة الصنع</td>
                            <td>${machine.year || '-'}</td>
                        </tr>
                        <tr>
                            <td>الشركة المصنعة</td>
                            <td>${machine.manufacturer || '-'}</td>
                            <td>بلد المنشأ</td>
                            <td>${machine.country || '-'}</td>
                        </tr>
                        <tr>
                            <td>الحالة</td>
                            <td>${Utils.getConditionName(machine.condition)}</td>
                            <td>الاستخدام</td>
                            <td>${Utils.getUsageName(machine.usage)}</td>
                        </tr>
                        <tr>
                            <td>ساعات التشغيل</td>
                            <td>${machine.hours || '-'} ${machine.hoursUnit || ''}</td>
                            <td>الموقع</td>
                            <td>${machine.location || '-'}</td>
                        </tr>
                    </table>
                    ${machine.notes ? `<p style="margin-top: 10px;"><strong>ملاحظات:</strong> ${machine.notes}</p>` : ''}
                    ${machine.images && machine.images.length > 0 ? `
                        <div class="machine-images">
                            ${machine.images.slice(0, 3).map(img => `<img src="${img}" alt="صورة الآلة">`).join('')}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        function displayValuesTable(machines) {
            const tbody = document.getElementById('valuesTableBody');
            let total = 0;
            
            if (machines.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" class="text-center">لا توجد آلات</td></tr>';
                return;
            }
            
            tbody.innerHTML = machines.map((machine, index) => {
                const value = parseFloat(machine.value) || 0;
                total += value;
                return `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${machine.name || machine.type || '-'}</td>
                        <td>${Utils.getConditionName(machine.condition)}</td>
                        <td>${Utils.formatCurrency(value)}</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('totalValue').textContent = Utils.formatCurrency(total);
            document.getElementById('totalValueWords').textContent = Utils.numberToArabicWords(total) + ' ريال سعودي فقط لا غير';
        }
        
        function initPreviewEvents(reportId) {
            // تعديل
            document.getElementById('editBtn').addEventListener('click', () => {
                window.location.href = `new-report.html?edit=${reportId}`;
            });
            
            // طباعة
            document.getElementById('printBtn').addEventListener('click', () => {
                window.print();
            });
            
            // إرسال بالبريد
            document.getElementById('emailBtn').addEventListener('click', () => {
                const report = Storage.getReport(reportId);
                const subject = encodeURIComponent(`تقرير تقييم - ${report.projectNumber}`);
                const body = encodeURIComponent(`
مرفق تقرير تقييم الآلات والمعدات

رقم التقرير: ${report.projectNumber}
العميل: ${report.clientName}
التاريخ: ${report.evaluationDate}

مع أطيب التحيات
                `);
                window.location.href = `mailto:?subject=${subject}&body=${body}`;
            });
            
            // تصدير PDF
            document.getElementById('exportPdfBtn').addEventListener('click', exportToPDF);
        }
        
        function exportToPDF() {
            const element = document.getElementById('reportContent');
            const report = Storage.getReport(new URLSearchParams(window.location.search).get('id'));
            
            const opt = {
                margin: 10,
                filename: `تقرير_${report?.projectNumber || 'تقييم'}.pdf`,
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { 
                    scale: 2,
                    useCORS: true,
                    logging: false
                },
                jsPDF: { 
                    unit: 'mm', 
                    format: 'a4', 
                    orientation: 'portrait'
                }
            };
            
            Swal.fire({
                title: 'جاري إنشاء PDF...',
                text: 'يرجى الانتظار',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });
            
            html2pdf().set(opt).from(element).save().then(() => {
                Swal.fire({
                    icon: 'success',
                    title: 'تم التصدير',
                    text: 'تم تصدير التقرير بنجاح',
                    timer: 1500,
                    showConfirmButton: false
                });
            }).catch(err => {
                Swal.fire({
                    icon: 'error',
                    title: 'خطأ',
                    text: 'حدث خطأ أثناء التصدير'
                });
            });
        }
    </script>
</body>
</html>
